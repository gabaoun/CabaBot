<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ bot_name }} Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #121212; color: #e0e0e0; }
        .card { background-color: #1e1e1e; border: 1px solid #333; margin-bottom: 20px; }
        .list-group-item { border-color: #333; }
        .btn-control { width: 100%; margin-top: 5px; }
        .status-badge { float: right; }
        /* Scrollbar customizada para a fila */
        .queue-list { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">üéõÔ∏è {{ bot_name }} Control</span>
        </div>
    </nav>

    <div class="container" id="guilds-container">
        <div class="text-center">
            <div class="spinner-border text-light" role="status"></div>
            <p>Carregando servidores...</p>
        </div>
    </div>

    <!-- Toast para notifica√ß√µes -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="liveToast" class="toast text-bg-primary" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">Bot</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-message">
          A√ß√£o realizada!
        </div>
      </div>
    </div>

    <script>
        // Previne atualiza√ß√£o da interface enquanto o usu√°rio digita
        let isTyping = false;

        function showToast(message) {
            const toastEl = document.getElementById('liveToast');
            document.getElementById('toast-message').innerText = message;
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        async function updateStatus() {
            if (isTyping) return; // N√£o atualiza se estiver digitando

            try {
                const response = await fetch('/api/status');
                const guilds = await response.json();
                const container = document.getElementById('guilds-container');
                
                // Salva o foco atual ou input value se houver (muito complexo para refresh total,
                // ideal seria diffing, mas vamos apenas limpar se n√£o estiver focado)
                // Simplifica√ß√£o: Refresh total a cada 2s √© ok se n√£o estiver digitando.
                
                container.innerHTML = '';

                if (guilds.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">O bot n√£o est√° em nenhum servidor ou n√£o carregou ainda.</div>';
                    return;
                }

                guilds.forEach(guild => {
                    const isPlaying = guild.is_playing;
                    const trackName = guild.current_track ? guild.current_track.title : "Nada tocando";
                    const requester = guild.current_track ? `Pedido por: ${guild.current_track.requester}` : "";
                    
                    const queueList = guild.queue.map((track, index) => `
                        <li class="list-group-item bg-dark text-white d-flex justify-content-between align-items-center">
                            <div class="text-truncate" style="max-width: 80%;">
                                <strong>${index + 1}.</strong> ${track.title}
                                <br><small class="text-muted" style="font-size: 0.75em">üë§ ${track.requester}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeQueue('${guild.id}', ${index})">üóëÔ∏è</button>
                        </li>
                    `).join('');

                    const html = `
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <strong>${guild.name}</strong>
                                <span class="badge bg-${isPlaying ? 'success' : 'secondary'}">
                                    ${isPlaying ? 'Tocando' : 'Parado'}
                                </span>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title text-truncate">${trackName}</h5>
                                <p class="card-text text-muted mb-3">${requester}</p>
                                
                                <!-- Controles Principais -->
                                <div class="row mb-3 g-2">
                                     <div class="col-3">
                                        <button onclick="control('${guild.id}', 'previous')" class="btn btn-secondary btn-control" ${guild.has_history ? '' : 'disabled'}>‚èÆÔ∏è</button>
                                    </div>
                                    <div class="col-3">
                                        <button onclick="control('${guild.id}', 'pause')" class="btn btn-${guild.is_paused ? 'success' : 'primary'} btn-control">
                                            ${guild.is_paused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è'}
                                        </button>
                                    </div>
                                    <div class="col-3">
                                        <button onclick="control('${guild.id}', 'skip')" class="btn btn-secondary btn-control">‚è≠Ô∏è</button>
                                    </div>
                                    <div class="col-3">
                                        <button onclick="control('${guild.id}', 'stop')" class="btn btn-danger btn-control">‚èπÔ∏è</button>
                                    </div>
                                </div>

                                <!-- Adicionar M√∫sica -->
                                <div class="input-group mb-3">
                                    <input type="text" id="input-${guild.id}" class="form-control bg-dark text-white border-secondary" 
                                        placeholder="URL ou Nome da m√∫sica"
                                        onfocus="isTyping=true" onblur="isTyping=false"
                                        onkeypress="if(event.key === 'Enter') addQueue('${guild.id}')">
                                    <button class="btn btn-success" type="button" onclick="addQueue('${guild.id}')">‚ûï</button>
                                </div>

                                <!-- Fila -->
                                <h6 class="border-bottom border-secondary pb-2 mb-2">
                                    Fila (${guild.queue_count})
                                </h6>
                                <ul class="list-group list-group-flush queue-list bg-dark">
                                    ${guild.queue.length > 0 ? queueList : '<li class="list-group-item bg-dark text-muted text-center">Fila vazia</li>'}
                                </ul>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                });
            } catch (error) {
                console.error('Erro ao atualizar:', error);
            }
        }

        async function control(guildId, action) {
            await fetch(`/api/control/${action}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ guild_id: guildId })
            });
            updateStatus();
        }

        async function addQueue(guildId) {
            const input = document.getElementById(`input-${guildId}`);
            const query = input.value;
            if (!query) return;

            // Feedback visual imediato
            input.value = '';
            input.blur(); 
            isTyping = false;
            showToast("Buscando e adicionando...");

            const res = await fetch('/api/queue/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ guild_id: guildId, query: query })
            });
            const data = await res.json();
            showToast(data.message);
            updateStatus();
        }

        async function removeQueue(guildId, index) {
            if(!confirm("Remover esta m√∫sica da fila?")) return;
            
            await fetch('/api/queue/remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ guild_id: guildId, index: index })
            });
            showToast("M√∫sica removida.");
            updateStatus();
        }

        // Atualiza a cada 3 segundos
        setInterval(updateStatus, 3000);
        updateStatus();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>